<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Eye Tracking – Off Task Detection (Stable)</title>
<script src="https://webgazer.cs.brown.edu/webgazer.js"></script>

<style>
  body {
    margin: 0;
    background: #020617;
    color: #e5e7eb;
    font-family: system-ui, sans-serif;
    overflow: hidden;
  }

  #taskFrame {
    position: absolute;
    left: 15%;
    top: 15%;
    width: 70%;
    height: 70%;
    border: 3px solid #e5e7eb;
    box-sizing: border-box;
  }

  #dot {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: red;
    pointer-events: none;
    z-index: 1000;
  }

  #info {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-size: 14px;
    color: #94a3b8;
  }
</style>
</head>

<body>

<div id="taskFrame"></div>
<div id="dot"></div>
<div id="info">Initializing…</div>

<script>
/* ================================
   CONFIG
================================ */
const OFF_MIN_MS = 500;
const DIR_WINDOW_MS = 400;
const DIR_DOMINANCE_RATIO = 0.45;
const DIR_DEADZONE_RATIO = 0.10;

const EMA_ALPHA = 0.35;
const MEDIAN_WINDOW = 5;

/* ================================
   STATE
================================ */
let lastT = null;
let offStart = null;
let offDir = null;
let votesStart = null;

let dirMs = { L:0, R:0, U:0, D:0 };

let gazeStats = {
  offEvents: 0,
  off_unknown_events: 0,
  offLeftEvents: 0,
  offRightEvents: 0,
  offUpEvents: 0,
  offDownEvents: 0
};

let rawBuffer = [];
let emaX = null;
let emaY = null;

/* ================================
   HELPERS
================================ */
function median(arr){
  const s = [...arr].sort((a,b)=>a-b);
  const m = Math.floor(s.length/2);
  return s.length % 2 ? s[m] : (s[m-1]+s[m])/2;
}

function smooth(x,y){
  rawBuffer.push({x,y});
  if (rawBuffer.length > MEDIAN_WINDOW) rawBuffer.shift();

  const mx = median(rawBuffer.map(p=>p.x));
  const my = median(rawBuffer.map(p=>p.y));

  emaX = emaX===null ? mx : emaX + EMA_ALPHA*(mx-emaX);
  emaY = emaY===null ? my : emaY + EMA_ALPHA*(my-emaY);

  return {x:emaX, y:emaY};
}

function classifyZone(x,y){
  const r = taskFrame.getBoundingClientRect();

  if (x>=r.left && x<=r.right && y>=r.top && y<=r.bottom)
    return "T";

  const cx = (r.left+r.right)/2;
  const cy = (r.top+r.bottom)/2;
  const dx = x-cx;
  const dy = y-cy;

  const adx = Math.abs(dx);
  const ady = Math.abs(dy);

  const dzx = (r.width/2)*DIR_DEADZONE_RATIO;
  const dzy = (r.height/2)*DIR_DEADZONE_RATIO;

  if (adx<dzx && ady<dzy) return "O";

  return adx>ady ? (dx<0?"L":"R") : (dy<0?"U":"D");
}

/* ================================
   MAIN GAZE HANDLER
================================ */
function handleGaze(data, t){
  if (!data) return;

  if (!lastT) lastT = t;
  const dt = t-lastT;
  lastT = t;

  const fixed = smooth(data.x, data.y);

  // draw dot
  dot.style.left = fixed.x+"px";
  dot.style.top = fixed.y+"px";

  const zone = classifyZone(fixed.x, fixed.y);

  if (zone !== "T") {
    if (!offStart){
      offStart = t;
      votesStart = t;
      dirMs = {L:0,R:0,U:0,D:0};
      offDir = null;
    }

    if (zone!=="O") dirMs[zone]+=dt;

    if ((t-votesStart)>=DIR_WINDOW_MS && !offDir){
      const arr = Object.entries(dirMs).sort((a,b)=>b[1]-a[1]);
      if (arr[0][1]>=DIR_WINDOW_MS*DIR_DOMINANCE_RATIO)
        offDir = arr[0][0];
      votesStart = t;
      dirMs = {L:0,R:0,U:0,D:0};
    }

  } else {
    if (offStart && (t-offStart)>=OFF_MIN_MS){
      gazeStats.offEvents++;
      if (!offDir) gazeStats.off_unknown_events++;
      else if (offDir==="L") gazeStats.offLeftEvents++;
      else if (offDir==="R") gazeStats.offRightEvents++;
      else if (offDir==="U") gazeStats.offUpEvents++;
      else if (offDir==="D") gazeStats.offDownEvents++;
    }
    offStart = null;
    offDir = null;
    votesStart = null;
  }

  info.innerText =
    `Zone: ${zone} | OFF events: ${gazeStats.offEvents} | L:${gazeStats.offLeftEvents} R:${gazeStats.offRightEvents} U:${gazeStats.offUpEvents} D:${gazeStats.offDownEvents} Unknown:${gazeStats.off_unknown_events}`;
}

/* ================================
   INIT
================================ */
webgazer
  .setGazeListener(handleGaze)
  .showVideo(false)
  .showFaceOverlay(false)
  .showFaceFeedbackBox(false)
  .begin();

</script>
</body>
</html>
