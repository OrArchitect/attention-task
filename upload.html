<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×”×¢×œ××ª ×ª××•× ×” â€“ ×¢××“×ª ×¢×‘×•×“×”</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background:#020617;
      color:#e5e7eb;
      display:flex;
      min-height:100vh;
      align-items:center;
      justify-content:center;
    }
    .card {
      background:#0b1120;
      border-radius:16px;
      padding:20px;
      max-width:420px;
      width:100%;
      box-shadow:0 20px 40px rgba(0,0,0,0.5);
    }
    h1 {
      font-size:1.3rem;
      margin-top:0;
      margin-bottom:0.5rem;
      text-align:right;
    }
    p {
      font-size:0.9rem;
      margin-top:0;
      margin-bottom:0.5rem;
      color:#cbd5f5;
    }
    label {
      font-size:0.85rem;
      display:block;
      margin-bottom:0.25rem;
    }
    input[type="text"] {
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #1e293b;
      background:#020617;
      color:#e5e7eb;
      box-sizing:border-box;
      margin-bottom:0.75rem;
    }
    .video-wrap, .canvas-wrap {
      width:100%;
      border-radius:12px;
      overflow:hidden;
      background:#020617;
      margin:0.75rem 0;
      position:relative;
    }
    video, canvas {
      width:100%;
      display:block;
    }
    .buttons {
      display:flex;
      gap:8px;
      margin-top:0.5rem;
      flex-wrap:wrap;
    }
    button {
      flex:1;
      padding:8px 10px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:0.9rem;
      background:#e5e7eb;
      color:#020617;
    }
    button.secondary {
      background:#020617;
      color:#e5e7eb;
      border:1px solid #1e293b;
    }
    button:disabled {
      opacity:0.4;
      cursor:not-allowed;
    }
    .status {
      margin-top:0.75rem;
      font-size:0.85rem;
      min-height:1.2em;
    }
    .small {
      font-size:0.75rem;
      color:#94a3b8;
      margin-top:0.5rem;
    }

    /* Success Overlay â€“ Fullscreen */
    #successOverlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }

    .successBox {
      background: #0b1120;
      padding: 30px 25px;
      border-radius: 16px;
      text-align: center;
      max-width: 340px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }

    .successBox h2 {
      margin: 0 0 10px;
      color: #e5e7eb;
      font-size: 1.4rem;
    }

    .successBox p {
      margin: 6px 0;
      color: #cbd5f5;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>×¦×™×œ×•× ×¢××“×ª ×”×¢×‘×•×“×”</h1>
    <p>
      ×œ×¤× ×™ ×ª×—×™×œ×ª ×”××©×™××”, ×× × ×¦×œ×/×™ ×ª××•× ×” ×©×œ ×¢××“×ª ×”×¢×‘×•×“×” ×©×œ×š ×•×œ×—×¥/×™ ×¢×œ "×”×¢×œ×” ×•×©××•×¨".
      ×”×ª××•× ×” ×ª×™×©××¨ ×‘××•×¤×Ÿ ×× ×•× ×™××™ ×ª×—×ª ×§×•×“ ×”××©×ª×ª×£ (PID) ×‘×œ×‘×“.
    </p>

    <label for="pidInput">×§×•×“ ××©×ª×ª×£ (PID)</label>
    <input id="pidInput" type="text" placeholder="×œ×“×•×’××”: P1032" />

    <div class="video-wrap" id="videoContainer">
      <video id="video" autoplay playsinline></video>
    </div>

    <div class="canvas-wrap" id="photoContainer" style="display:none;">
      <canvas id="photoCanvas"></canvas>
    </div>

    <div class="buttons">
      <button id="startBtn" type="button">×”×¤×¢×œ ××¦×œ××”</button>
      <button id="captureBtn" type="button" disabled>×¦×œ×</button>
      <button id="uploadBtn" type="button" disabled>×”×¢×œ×” ×•×©××•×¨</button>
    </div>

    <div class="status" id="status"></div>
    <div class="small">
      ×”×ª××•× ×” × ×©××¨×ª ×‘×—×©×‘×•×Ÿ ×”××—×¡×•×Ÿ ×©×œ ×”×—×•×§×¨ ×‘×œ×‘×“, ×•××™× ×” ××§×•×©×¨×ª ×œ×©× ××• ×œ×—×©×‘×•×Ÿ Google ×©×œ×š.
      ×œ××—×¨ ×”×”×¢×œ××” × ×™×ª×Ÿ ×œ×¡×’×•×¨ ×—×œ×•×Ÿ ×–×” ×•×œ×—×–×•×¨ ×œ×˜×•×¤×¡ / ×œ××©×™××”.
    </div>
  </div>

  <!-- ××¡×š ×ª×•×“×” ×¢×œ ×›×œ ×”××¡×š -->
  <div id="successOverlay">
    <div class="successBox">
      <h2>×”×ª××•× ×” ×”×•×¢×œ×ª×” ×‘×”×¦×œ×—×”!</h2>
      <p>×ª×•×“×” ×¨×‘×” ğŸ™</p>
      <p>× ×™×ª×Ÿ ×›×¢×ª ×œ×—×–×•×¨ ×œ×˜×•×¤×¡ ×•×œ×”××©×™×š ×‘×©××œ×•×Ÿ.</p>
    </div>
  </div>

  <script>
    // === ×”×’×“×¨×•×ª ×‘×¡×™×¡×™×•×ª ===
    const apiKey = "6a6e1e8b48e383e4c4ef6e6311ffee52"; // ××¤×ª×— ×”-API ×©×œ×š ×‘-imgbb
    const apiUrl = "https://api.imgbb.com/1/upload";

    const pidInput       = document.getElementById("pidInput");
    const video          = document.getElementById("video");
    const videoContainer = document.getElementById("videoContainer");
    const photoContainer = document.getElementById("photoContainer");
    const photoCanvas    = document.getElementById("photoCanvas");
    const startBtn       = document.getElementById("startBtn");
    const captureBtn     = document.getElementById("captureBtn");
    const uploadBtn      = document.getElementById("uploadBtn");
    const statusEl       = document.getElementById("status");
    const successOverlay = document.getElementById("successOverlay");

    let stream = null;
    let imageDataBase64 = null;

    // × ×¡×” ×œ×˜×¢×•×Ÿ PID ××”-URL ×× ×§×™×™× (?pid=XXX)
    (function initPidFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const pidFromUrl = params.get("pid");
      if (pidFromUrl) {
        pidInput.value = pidFromUrl;
      }
    })();

    startBtn.addEventListener("click", async () => {
      statusEl.textContent = "";
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" }
        });
        video.srcObject = stream;
        captureBtn.disabled = false;
        statusEl.textContent = "×”××¦×œ××” ×”×•×¤×¢×œ×”. ×›×•×•×Ÿ/×™ ××ª ×”××¦×œ××” ×œ×¢××“×ª ×”×¢×‘×•×“×” ×•×œ×—×¥/×™ ×¢×œ '×¦×œ×'.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "×œ× × ×™×ª×Ÿ ×”×™×” ×œ×”×¤×¢×™×œ ××ª ×”××¦×œ××”. ×× × ×‘×“×•×§/×™ ×”×¨×©××•×ª ×‘×“×¤×“×¤×Ÿ.";
      }
    });

    captureBtn.addEventListener("click", () => {
      if (!stream) return;

      const trackSettings = stream.getVideoTracks()[0].getSettings();
      const width  = trackSettings.width  || 640;
      const height = trackSettings.height || 480;

      photoCanvas.width  = width;
      photoCanvas.height = height;
      const ctx = photoCanvas.getContext("2d");
      ctx.drawImage(video, 0, 0, width, height);

      // ×¢×¦×™×¨×ª ×”×•×•×™×“××• ×œ××—×¨ ×”×¦×™×œ×•×
      stream.getTracks().forEach(t => t.stop());
      stream = null;

      // ×”××¨×ª ×”×ª××•× ×” ×œ-base64 (×‘×œ×™ ×”-prefix)
      const dataUrl = photoCanvas.toDataURL("image/jpeg", 0.9);
      imageDataBase64 = dataUrl.split(",")[1];

      videoContainer.style.display  = "none";
      photoContainer.style.display  = "block";
      uploadBtn.disabled            = false;
      captureBtn.disabled           = true;

      statusEl.textContent = "×ª×¦×•×’×” ××§×“×™××” × ×©××¨×”. ×× ×”×ª××•× ×” × ×¨××™×ª ×˜×•×‘ â€“ ×œ×—×¥/×™ '×”×¢×œ×” ×•×©××•×¨'.";
    });

    uploadBtn.addEventListener("click", async () => {
      const pid = pidInput.value.trim();
      if (!pid) {
        statusEl.textContent = "× × ×œ×”×–×™×Ÿ ×§×•×“ ××©×ª×ª×£ (PID) ×œ×¤× ×™ ×”×”×¢×œ××”.";
        return;
      }
      if (!imageDataBase64) {
        statusEl.textContent = "×œ× × ××¦××” ×ª××•× ×” ×œ×”×¢×œ××”. × × ×œ×¦×œ× ××—×“×©.";
        return;
      }

      uploadBtn.disabled = true;
      statusEl.textContent = "××¢×œ×” ××ª ×”×ª××•× ×”... ×× × ×”××ª×Ÿ/×™.";

      try {
        const formData = new FormData();
        formData.append("key", apiKey);
        formData.append("image", imageDataBase64);
        formData.append("name", `pid_${pid}`);

        const res = await fetch(apiUrl, {
          method: "POST",
          body: formData
        });

        const json = await res.json();
        if (!json.success) {
          console.error(json);
          statusEl.textContent = "×—×œ×” ×©×’×™××” ×‘×”×¢×œ××”. × × ×œ× ×¡×•×ª ×©×•×‘.";
          uploadBtn.disabled = false;
          return;
        }

        // ×”×¦×’×ª ××¡×š ×ª×•×“×” ×¢×œ ×›×œ ×”××¡×š
        successOverlay.style.display = "flex";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "×©×’×™××ª ×ª×§×©×•×¨×ª ×‘×¢×ª ×”×”×¢×œ××”. × × ×œ× ×¡×•×ª ×©×•×‘.";
        uploadBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
