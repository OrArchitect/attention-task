<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Connect-the-Dots – Eye Tracking Version (v2)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#000000;
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --error:#fb7185;
      --ok:#4ade80;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    body{
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .shell{
      width:100%;
      max-width:1100px;
      padding:1.5rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      flex-wrap:wrap;
    }
    header h1{
      margin:0;
      font-size:1.3rem;
    }
    header p{
      margin:.25rem 0 0;
      font-size:.8rem;
      color:var(--muted);
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:.75rem;
      font-size:.85rem;
      align-items:flex-end;
    }
    .meta label{
      display:flex;
      flex-direction:column;
      gap:.2rem;
    }
    .meta input,
    .meta select{
      background:#020617;
      border-radius:.5rem;
      border:1px solid #1f2937;
      padding:.3rem .6rem;
      color:var(--ink);
      min-width:7.5rem;
    }
    .meta input:focus,
    .meta select:focus{
      outline:none;
      border-color:var(--accent);
    }
    button{
      border:none;
      border-radius:999px;
      padding:.45rem 1.2rem;
      font-size:.9rem;
      font-weight:500;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.4rem;
    }
    #startBtn{
      background:var(--accent);
      color:#020617;
    }
    #startBtn:disabled{
      opacity:.4;
      cursor:default;
    }
    main{
      margin-top:.75rem;
      display:grid;
      grid-template-columns:minmax(0,3fr) minmax(220px,1fr);
      gap:1rem;
    }
    @media (max-width:900px){
      main{grid-template-columns:1fr;}
    }
    .canvas-wrap{
      background:#020617;
      border-radius:1rem;
      border:1px solid #1f2937;
      padding:.75rem;
    }
    canvas{
      width:100%;
      height:520px;
      display:block;
      background:#020617;
      border-radius:.8rem;
    }
    .side{
      font-size:.8rem;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:.75rem;
    }
    #status{
      min-height:2rem;
      white-space:pre-wrap;
    }
    .ok{color:var(--ok);}
    .err{color:var(--error);}
    .tag{
      display:inline-flex;
      border-radius:999px;
      padding:.25rem .6rem;
      border:1px solid #1f2937;
      background:#020617;
      gap:.3rem;
      align-items:center;
    }
    .tag strong{color:var(--ink);}
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <h1>Connect-the-Dots – Eye Tracking Version</h1>
        <p>המשתתף יתבקש לחבר את המספרים לפי הסדר אחרי פיקסציה קצרה באמצע המסך.</p>
      </div>
      <div class="tag">
        <span>משך:</span><strong id="timer">00:00</strong>
      </div>
    </header>

    <div class="meta">
      <label>
        Participant ID:
        <input id="pid" placeholder="S01" autocomplete="off" />
      </label>
      <label>
        Condition:
        <select id="condition">
          <option value="A">A – Large window left</option>
          <option value="B">B – Small window right</option>
          <option value="C">C – No window</option>
        </select>
      </label>
      <label>
        Order:
        <select id="order">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </label>
      <button id="startBtn">Start task (after fixation)</button>
    </div>

    <main>
      <div class="canvas-wrap">
        <canvas id="board" width="960" height="520"></canvas>
      </div>
      <div class="side">
        <div>
          <strong>Protocol (eye-tracking):</strong>
          <ul>
            <li>מסך כהה.</li>
            <li>לאחר לחיצה על Start – פיקסציה באמצע המסך (צלב לבן) למשך 1500ms.</li>
            <li>לאחר מכן – הופעת הנקודות והתחלת המשימה.</li>
            <li>לוג כולל אירועי FIXATION_ON, FIXATION_OFF, TASK_START, TASK_END.</li>
          </ul>
        </div>
        <div>
          <strong>Status:</strong>
          <div id="status"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbybO1_akQMKOO4TkATG62fJDOFWo1fwJQdmyQ_bZaIXm6Go29DcvGypYUHBJ-NW-CEQ/exec";

    const canvas = document.getElementById("board");
    const ctx = canvas.getContext("2d");
    const statusEl = document.getElementById("status");
    const timerEl = document.getElementById("timer");
    const startBtn = document.getElementById("startBtn");

    const basePoints = [
      { id: 1,  x: 0.12, y: 0.80 },
      { id: 2,  x: 0.25, y: 0.60 },
      { id: 3,  x: 0.18, y: 0.30 },
      { id: 4,  x: 0.35, y: 0.18 },
      { id: 5,  x: 0.52, y: 0.26 },
      { id: 6,  x: 0.70, y: 0.18 },
      { id: 7,  x: 0.84, y: 0.34 },
      { id: 8,  x: 0.76, y: 0.60 },
      { id: 9,  x: 0.58, y: 0.78 },
      { id:10,  x: 0.40, y: 0.82 },
      { id:11,  x: 0.54, y: 0.48 },
      { id:12,  x: 0.32, y: 0.52 }
    ];

    let points = [];
    let running = false;
    let inFixation = false;
    let currentTarget = 1;
    let taskStartTime = 0;
    let lastClickTime = 0;
    let timerInterval = null;

    const logRows = [];

    function resizePoints(){
      points = basePoints.map(p=>({
        id:p.id,
        x:p.x*canvas.width,
        y:p.y*canvas.height
      }));
    }

    function clearCanvas(){
      ctx.fillStyle = "#020617";
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    function drawFixation(){
      clearCanvas();
      const cx = canvas.width/2;
      const cy = canvas.height/2;
      ctx.strokeStyle="#e5e7eb";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(cx-25,cy);
      ctx.lineTo(cx+25,cy);
      ctx.moveTo(cx,cy-25);
      ctx.lineTo(cx,cy+25);
      ctx.stroke();
    }

    function drawDots(){
      clearCanvas();
      for(const p of points){
        ctx.beginPath();
        ctx.arc(p.x,p.y,16,0,Math.PI*2);
        ctx.fillStyle = (running && p.id===currentTarget) ? "#38bdf8" : "#0f172a";
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle="#1f2937";
        ctx.stroke();

        ctx.fillStyle="#e5e7eb";
        ctx.font="bold 14px system-ui";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.fillText(String(p.id),p.x,p.y);
      }
    }

    function logEvent(type, extra={}){
      const now = performance.now();
      logRows.push({
        kind:"event",
        type,
        tMs: Math.round(now - (taskStartTime || now)),
        ...extra
      });
    }

    function resetTask(){
      resizePoints();
      running=false;
      inFixation=false;
      currentTarget=1;
      taskStartTime=0;
      lastClickTime=0;
      logRows.length=0;
      stopTimer();
      timerEl.textContent="00:00";
      statusEl.textContent="לביצוע: מלא/י Participant ID, בחר/י תנאי וסדר, ואז לחץ Start.";
      clearCanvas();
    }

    function startTimer(){
      stopTimer();
      timerInterval=setInterval(()=>{
        if(!taskStartTime || !running) return;
        const t = Math.floor((performance.now()-taskStartTime)/1000);
        const mm=String(Math.floor(t/60)).padStart(2,"0");
        const ss=String(t%60).padStart(2,"0");
        timerEl.textContent=mm+":"+ss;
      },250);
    }
    function stopTimer(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval=null;
      }
    }

    function startProtocol(){
      const pid = document.getElementById("pid").value.trim();
      if(!pid){
        statusEl.innerHTML="<span class='err'>Please enter Participant ID first.</span>";
        return;
      }

      // לוג התחלה (לפני פיקסציה)
      logEvent("TASK_INIT",{
        screenW:window.innerWidth,
        screenH:window.innerHeight
      });

      inFixation=true;
      running=false;
      currentTarget=1;
      drawFixation();
      statusEl.textContent="Fixation...";

      logEvent("FIXATION_ON");

      setTimeout(()=>{
        inFixation=false;
        taskStartTime=performance.now();
        lastClickTime=taskStartTime;
        running=true;
        drawDots();
        statusEl.textContent="Connect the numbers in ascending order.";
        logEvent("FIXATION_OFF");
        logEvent("TASK_START");
        startTimer();
      },1500); // 1.5 שניות פיקסציה
    }

    canvas.addEventListener("click", ev=>{
      const rect = canvas.getBoundingClientRect();
      const x = ev.clientX - rect.left;
      const y = ev.clientY - rect.top;

      if(!running){
        return;
      }

      const now = performance.now();
      const rt = now - lastClickTime;
      lastClickTime = now;

      const hit = (()=> {
        const radius=20;
        let best=null, bestDist=Infinity;
        for(const p of points){
          const dx=x-p.x, dy=y-p.y;
          const d=Math.hypot(dx,dy);
          if(d<radius && d<bestDist){
            best=p; bestDist=d;
          }
        }
        return best ? {point:best, dist:bestDist} : null;
      })();

      if(!hit){
        logRows.push({
          kind:"sample",
          type:"miss",
          order:currentTarget,
          clickX:x,
          clickY:y,
          rtMs:Math.round(rt),
          tMs:Math.round(now-taskStartTime)
        });
        statusEl.innerHTML="<span class='err'>Miss – try to click exactly on " + currentTarget + ".</span>";
        return;
      }

      const correct = hit.point.id === currentTarget;

      logRows.push({
        kind:"sample",
        type:"click",
        fromId:hit.point.id,
        expectedId:currentTarget,
        correct,
        clickX:x,
        clickY:y,
        pointX:hit.point.x,
        pointY:hit.point.y,
        distanceToCenter:Math.round(hit.dist),
        rtMs:Math.round(rt),
        tMs:Math.round(now-taskStartTime)
      });

      if(!correct){
        statusEl.innerHTML="<span class='err'>Wrong number – you should look for " + currentTarget + ".</span>";
        return;
      }

      if(currentTarget>1){
        const prev=points.find(p=>p.id===currentTarget-1);
        ctx.beginPath();
        ctx.moveTo(prev.x,prev.y);
        ctx.lineTo(hit.point.x,hit.point.y);
        ctx.strokeStyle="#38bdf8";
        ctx.lineWidth=3;
        ctx.stroke();
      }

      currentTarget++;
      if(currentTarget>points.length){
        running=false;
        stopTimer();
        const totalMs=Math.round(now-taskStartTime);
        statusEl.innerHTML="<span class='ok'>Task finished. Total time: "+totalMs+" ms.</span>";
        logEvent("TASK_END",{totalTimeMs:totalMs});

        const pid = document.getElementById("pid").value.trim() || "no_id";
        const condition = document.getElementById("condition").value;
        const order = document.getElementById("order").value;

        sendResultsToDrive(logRows,{
          participantId:pid,
          condition,
          order,
          version:"connect_dots_v2_eye",
          totalTimeMs:totalMs,
          screenW:window.innerWidth,
          screenH:window.innerHeight
        });
        return;
      }

      statusEl.textContent="Good. Now look for "+currentTarget+".";
      drawDots();
    });

    // ---------- שליחת הנתונים ל-Drive ----------

    function sendResultsToDrive(rows, meta={}){
      if(!rows || !rows.length){
        console.warn("sendResultsToDrive: no rows");
        return;
      }
      const metaPairs = Object.entries(meta).map(([k,v])=>`${k}=${v}`);
      let csv = "";
      if(metaPairs.length){
        csv += "# " + metaPairs.join(" | ") + "\n";
      }
      const headers = Object.keys(rows[0]);
      csv += headers.join(",") + "\n";
      for(const row of rows){
        const line = headers.map(h=>{
          const val=row[h] ?? "";
          return String(val).replace(/,/g,";");
        }).join(",");
        csv += line + "\n";
      }
      fetch(SCRIPT_URL,{
        method:"POST",
        mode:"no-cors",
        headers:{"Content-Type":"text/plain;charset=utf-8"},
        body:csv
      }).catch(err=>{
        console.error("Failed to send results:",err);
      });
    }

    // אתחול
    resetTask();
    startBtn.addEventListener("click", ()=>{ startProtocol(); });
  </script>
</body>
</html>
