<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>משימת חיבור נקודות – v2 (עם כיול מעקב עיניים)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- ספריית WebGazer למעקב עיניים -->
  <script src="https://webgazer.cs.brown.edu/webgazer.js" type="text/javascript"></script>

  <style>
    :root{
      --bg:#020617;
      --panel:#0b1120;
      --ink:#e5e7eb;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --error:#fb7185;
      --ok:#4ade80;
      --stroke:#1f2933;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    }
    body{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1.5rem;
    }
    .shell{
      width:100%;
      max-width:960px;
      background:var(--panel);
      border-radius:1.5rem;
      box-shadow:0 22px 45px rgba(15,23,42,.7);
      padding:1.5rem 2rem 2rem;
      display:flex;
      flex-direction:column;
      gap:1.25rem;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:1rem;
      flex-wrap:wrap;
    }
    header h1{
      margin:0;
      font-size:1.4rem;
    }
    header p{
      margin:.25rem 0 0;
      font-size:.85rem;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      padding:.25rem .6rem;
      border-radius:999px;
      border:1px solid #1e293b;
      background:#020617;
      gap:.4rem;
      align-items:center;
      font-size:.8rem;
      color:var(--muted);
      width:fit-content;
    }
    .pill strong{
      color:var(--ink);
      font-weight:600;
    }
    .meta-row{
      display:flex;
      flex-wrap:wrap;
      gap:.75rem;
      font-size:.85rem;
      align-items:flex-end;
    }
    .meta-row label{
      display:flex;
      flex-direction:column;
      gap:.25rem;
    }
    .meta-row input,
    .meta-row select{
      background:#020617;
      border:1px solid #1e293b;
      border-radius:.6rem;
      padding:.35rem .6rem;
      color:var(--ink);
      min-width:8rem;
    }
    .meta-row input:focus,
    .meta-row select:focus{
      outline:none;
      border-color:var(--accent);
    }
    button{
      border:none;
      border-radius:999px;
      padding:.5rem 1.1rem;
      font-size:.9rem;
      font-weight:500;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.4rem;
    }
    button:disabled{
      opacity:.45;
      cursor:default;
    }
    #startBtn{
      background:var(--accent);
      color:#020617;
    }
    #calibBtn,
    #finishCalibBtn{
      background:#020617;
      color:var(--ink);
      border:1px solid #1e293b;
    }
    #finishCalibBtn{
      display:none;
    }
    .main{
      display:grid;
      grid-template-columns:minmax(0,2fr) minmax(220px,1fr);
      gap:1rem;
    }
    @media (max-width:800px){
      .main{grid-template-columns:1fr;}
    }
    .canvas-wrap{
      background:#020617;
      border-radius:1rem;
      padding:.75rem;
      border:1px solid #1f2937;
    }
    canvas{
      display:block;
      width:100%;
      height:420px;
      background:#020617;
      border-radius:.75rem;
    }
    .side{
      display:flex;
      flex-direction:column;
      gap:.75rem;
      font-size:.85rem;
    }
    #status{
      min-height:2.2rem;
      white-space:pre-wrap;
    }
    .ok{color:var(--ok);}
    .err{color:var(--error);}
    ul{
      padding-left:1.1rem;
      margin:.25rem 0;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <h1>משימת חיבור נקודות – v2</h1>
        <p>חבר/י את המספרים לפי הסדר העולה (1, 2, 3, ...) במהירות ובדיוק מירביים.</p>
      </div>
      <div class="pill">
        <span>משך המשימה:</span><strong id="timer">00:00</strong>
      </div>
    </header>

    <div class="meta-row">
      <label>
        מזהה נבדק:
        <input id="pid" placeholder="לדוגמה: S01" autocomplete="off" />
      </label>
      <label>
        תנאי:
        <select id="condition">
          <option value="A">A – חלון גדול שמאל</option>
          <option value="B">B – חלון קטן ימין</option>
          <option value="C">C – ללא חלון</option>
        </select>
      </label>
      <label>
        סדר:
        <select id="order">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </label>

      <!-- שני הכפתורים החדשים -->
      <button id="calibBtn">כיול מעקב עיניים</button>
      <button id="finishCalibBtn">סיום כיול</button>

      <!-- כמו בקובץ הרגיל -->
      <button id="startBtn">התחלת המשימה</button>
    </div>

    <div class="main">
      <div class="canvas-wrap">
        <canvas id="board" width="800" height="420"></canvas>
      </div>
      <div class="side">
        <div>
          <strong>הוראות:</strong>
          <ul>
            <li>לחץ/י על 1 ואז על 2, 3 וכן הלאה.</li>
            <li>הקוים יצוירו אוטומטית רק כאשר הבחירה נכונה.</li>
            <li>טעויות נרשמות בלוג אך אינן מציירות קו.</li>
          </ul>
        </div>
        <div>
          <strong>סטטוס:</strong>
          <div id="status"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== שליחת CSV ל-Drive (כמו בגרסה הרגילה) =====
    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbybO1_akQMKOO4TkATG62fJDOFWo1fwJQdmyQ_bZaIXm6Go29DcvGypYUHBJ-NW-CEQ/exec";

    function sendResultsToDrive(rows, meta = {}) {
      if (!rows || !rows.length) return;
      const metaPairs = Object.entries(meta).map(([k,v]) => `${k}=${v}`);
      let csv = "";
      if (metaPairs.length) csv += "# " + metaPairs.join(" | ") + "\n";
      const headers = Object.keys(rows[0]);
      csv += headers.join(",") + "\n";
      for (const row of rows) {
        const line = headers.map(h => {
          const val = row[h] ?? "";
          return String(val).replace(/,/g,";");
        }).join(",");
        csv += line + "\n";
      }
      fetch(SCRIPT_URL,{
        method:"POST",
        mode:"no-cors",
        headers:{"Content-Type":"text/plain;charset=utf-8"},
        body:csv
      }).catch(err=>console.error("Failed to send results:",err));
    }

    // ===== לוגיקת המשימה – זהה לגרסה הרגילה =====
    const canvas   = document.getElementById("board");
    const ctx      = canvas.getContext("2d");
    const timerEl  = document.getElementById("timer");
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const calibBtn = document.getElementById("calibBtn");
    const finishCalibBtn = document.getElementById("finishCalibBtn");

    const basePoints = [
      { id: 1,  x: 0.10, y: 0.80 },
      { id: 2,  x: 0.25, y: 0.65 },
      { id: 3,  x: 0.18, y: 0.35 },
      { id: 4,  x: 0.35, y: 0.20 },
      { id: 5,  x: 0.50, y: 0.30 },
      { id: 6,  x: 0.65, y: 0.18 },
      { id: 7,  x: 0.82, y: 0.30 },
      { id: 8,  x: 0.74, y: 0.55 },
      { id: 9,  x: 0.58, y: 0.72 },
      { id:10,  x: 0.40, y: 0.78 },
      { id:11,  x: 0.55, y: 0.50 },
      { id:12,  x: 0.32, y: 0.55 }
    ];

    let points = [];
    let currentTarget = 1;
    let running = false;
    let taskStartTime = 0;
    let lastClickTime = 0;
    let timerInterval = null;
    const eventLog = [];

    // משתני כיול
    let calibrationStarted = false;
    let calibrationDone    = false;

    function resizePoints() {
      points = basePoints.map(p => ({
        id:p.id,
        x:p.x*canvas.width,
        y:p.y*canvas.height
      }));
    }

    function drawBoard() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#020617";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      for (const p of points){
        ctx.beginPath();
        ctx.arc(p.x,p.y,16,0,Math.PI*2);
        ctx.fillStyle = (running && p.id===currentTarget) ? "#38bdf8" : "#0f172a";
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#1e293b";
        ctx.stroke();

        ctx.fillStyle = "#e5e7eb";
        ctx.font = "bold 14px system-ui";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(String(p.id),p.x,p.y);
      }
    }

    function resetTask() {
      resizePoints();
      currentTarget = 1;
      running = false;
      taskStartTime = 0;
      lastClickTime = 0;
      eventLog.length = 0;
      stopTimer();
      timerEl.textContent = "00:00";
      statusEl.textContent = "לחץ/י על \"התחלת המשימה\".";
      drawBoard();
    }

    function startTimer(){
      stopTimer();
      timerInterval = setInterval(()=>{
        if(!running) return;
        const t = Math.floor((performance.now()-taskStartTime)/1000);
        const mm = String(Math.floor(t/60)).padStart(2,"0");
        const ss = String(t%60).padStart(2,"0");
        timerEl.textContent = mm+":"+ss;
      },250);
    }
    function stopTimer(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval=null;
      }
    }

    function findClickedPoint(x,y){
      const radius=20;
      let best=null, bestDist=Infinity;
      for(const p of points){
        const dx=x-p.x, dy=y-p.y;
        const d=Math.hypot(dx,dy);
        if(d<radius && d<bestDist){
          best=p; bestDist=d;
        }
      }
      return best ? {point:best, dist:bestDist} : null;
    }

    // ===== כיול WebGazer =====
    async function startCalibration(){
      if(!window.webgazer){
        statusEl.innerHTML =
          "<span class='err'>WebGazer לא נטען. ניתן לבצע את המשימה גם בלי מעקב עיניים.</span>";
        return;
      }
      if(calibrationStarted) return;
      calibrationStarted = true;
      calibBtn.disabled = true;
      statusEl.textContent = "פותח מצלמה... אנא אשר/י גישה.";

      try{
        await webgazer.setRegression('ridge');
        await webgazer.setTracker('clmtrackr');
        webgazer.params.showVideoPreview = true;
        webgazer.params.showPredictionPoints = true;
        await webgazer.begin();

        finishCalibBtn.style.display = "inline-flex";
        statusEl.textContent =
          "הכיול פעיל – הסתכל/י על אזורים שונים במסך ובצע/י כמה קליקים. " +
          "כאשר מרגיש/ה שהכיול טוב, לחץ/י על \"סיום כיול\".";
      }catch(err){
        console.error(err);
        calibrationStarted = false;
        calibBtn.disabled = false;
        statusEl.innerHTML =
          "<span class='err'>שגיאה בהפעלת WebGazer. ניתן להמשיך את המשימה גם בלי מעקב עיניים.</span>";
      }
    }

    function finishCalibration(){
      if(!calibrationStarted) return;
      calibrationDone = true;
      finishCalibBtn.style.display = "none";
      statusEl.innerHTML =
        "<span class='ok'>הכיול הושלם. כעת ניתן להזין PID וללחוץ על \"התחלת המשימה\".</span>";

      if(window.webgazer){
        webgazer.showVideoPreview(false);
        webgazer.showPredictionPoints(false);
      }
    }

    // ===== התחלת המשימה (עם בדיקות כיול ו-PID) =====
    function startTask(){
      if(!calibrationDone){
        statusEl.innerHTML =
          "<span class='err'>יש לבצע קודם כיול מעקב עיניים (\"כיול מעקב עיניים\" ואז \"סיום כיול\").</span>";
        return;
      }
      const pid = document.getElementById("pid").value.trim();
      if(!pid){
        statusEl.innerHTML =
          "<span class='err'>נא להזין מזהה נבדק (PID) לפני תחילת המשימה.</span>";
        return;
      }

      running = true;
      currentTarget=1;
      eventLog.length=0;
      taskStartTime=performance.now();
      lastClickTime=taskStartTime;
      statusEl.textContent="המשימה החלה. התחיל/י מהמספר 1.";
      startTimer();
      drawBoard();
    }

    canvas.addEventListener("click", ev=>{
      const rect = canvas.getBoundingClientRect();
      const x = ev.clientX - rect.left;
      const y = ev.clientY - rect.top;

      if(!running){
        // בזמן הכיול – הקליקים עוזרים ל-WebGazer בלבד
        return;
      }

      const now = performance.now();
      const rt  = now - lastClickTime;
      lastClickTime = now;

      const hit = findClickedPoint(x,y);

      if(!hit){
        eventLog.push({
          type:"miss",
          order:currentTarget,
          clickX:x,
          clickY:y,
          rtMs:Math.round(rt),
          timestampMs:Math.round(now-taskStartTime)
        });
        statusEl.innerHTML =
          "<span class='err'>לחיצה ריקה – נסה/י שוב על המספר " + currentTarget + ".</span>";
        return;
      }

      const correct = hit.point.id === currentTarget;

      eventLog.push({
        type:"click",
        fromId:hit.point.id,
        expectedId:currentTarget,
        correct,
        clickX:x,
        clickY:y,
        pointX:hit.point.x,
        pointY:hit.point.y,
        distanceToCenter:Math.round(hit.dist),
        rtMs:Math.round(rt),
        timestampMs:Math.round(now-taskStartTime)
      });

      if(!correct){
        statusEl.innerHTML =
          "<span class='err'>זה לא המספר הנכון. חפש/י את " + currentTarget + ".</span>";
        return;
      }

      if(currentTarget>1){
        const prev = points.find(p=>p.id===currentTarget-1);
        ctx.beginPath();
        ctx.moveTo(prev.x,prev.y);
        ctx.lineTo(hit.point.x,hit.point.y);
        ctx.strokeStyle="#38bdf8";
        ctx.lineWidth=3;
        ctx.stroke();
      }

      currentTarget++;
      if(currentTarget>points.length){
        running=false;
        stopTimer();
        const totalMs = Math.round(now-taskStartTime);
        statusEl.innerHTML =
          "<span class='ok'>המשימה הסתיימה! זמן כולל: " + totalMs + " מילישניות.</span>";

        const pid = document.getElementById("pid").value.trim() || "no_id";
        const condition = document.getElementById("condition").value;
        const order = document.getElementById("order").value;

        sendResultsToDrive(eventLog,{
          participantId:pid,
          condition,
          order,
          version:"connect_dots_v2_eye_webgazer",
          totalTimeMs:totalMs,
          screenW:window.innerWidth,
          screenH:window.innerHeight
        });
        return;
      }

      statusEl.textContent="מצוין. עכשיו לחפש את " + currentTarget + ".";
      drawBoard();
    });

    window.addEventListener("beforeunload",()=>{
      if(window.webgazer){
        webgazer.end();
      }
    });

    // אתחול
    resetTask();
    calibBtn.addEventListener("click",startCalibration);
    finishCalibBtn.addEventListener("click",finishCalibration);
    startBtn.addEventListener("click",startTask);
  </script>
</body>
</html>
